# Sentinel

## What

随着微服务的流行，服务和服务之间的**稳定性**变得越来越重要。Sentinel 是面向分布式服务架构的**轻量级流量控制框架**，主要以流量为切入点，从**流量控制**、**熔断降级**、**系统负载保护**等多个维度来帮助您保护服务的稳定性。

## 基本概念

### 资源

资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。
Url、RPC服务、甚至一块代码都可以看做是资源。

### 规则

围绕资源的实时状态设定的规则，可以包括流量控制规则、熔断降级规则以及系统保护规则。所有规则可以动态实时调整。

## 主要功能

### 流量控制

流量控制在网络传输中是一个常用的概念，它用于调整网络包的发送数据。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。**任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。**Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状，如下图所示：

![](assets/limitflow.gif)

流量控制有以下几个角度:

* 资源的调用关系，例如资源的调用链路，资源和资源之间的关系；
* 运行指标，例如 QPS、线程池、系统负载等；
* 控制的效果，例如**直接限流**、**冷启动**、**排队**等。

### 熔断降级

除了流量控制以外，降低调用链路中的**不稳定资源**也是 Sentinel 的使命之一。由于调用关系的复杂性，如果调用链路中的某个资源出现了不稳定，最终会导致请求发生堆积。

Sentinel 和 Hystrix 的原则是一致的: 当调用链路中某个资源出现不稳定，**例如，表现为 timeout，异常比例升高的时候，则对这个资源的调用进行限制，并让请求快速失败，避免影响到其它的资源，最终产生雪崩的效果。**


在限制的手段上，Sentinel 和 Hystrix 采取了完全不一样的方法。

Hystrix 通过**线程池**的方式，来对依赖(在我们的概念中对应资源)进行了隔离。这样做的好处是资源和资源之间做到了**最彻底的隔离**。缺点是除了**增加了线程切换的成本**，还需要预先给各个资源做线程池大小的分配。

Sentinel 对这个问题采取了两种手段:

* 通过并发线程数进行限制
  和资源池隔离的方法不同，Sentinel 通过限制资源并发线程的数量，来减少不稳定资源对其它资源的影响。这样不但没有线程切换的损耗，也不需要您预先分配线程池的大小。当某个资源出现不稳定的情况下，例如响应时间变长，对资源的直接影响就是会造成线程数的逐步堆积。**当线程数在特定资源上堆积到一定的数量之后，对该资源的新请求就会被拒绝**。堆积的线程完成任务后才开始继续接收请求。

* 通过响应时间对资源进行降级
  除了对并发线程数进行控制以外，Sentinel 还可以通过响应时间来快速降级不稳定的资源。**当依赖的资源出现响应时间过长后，所有对该资源的访问都会被直接拒绝，直到过了指定的时间窗口之后才重新恢复。**

### 系统负载保护

Sentinel 同时对系统的维度提供保护。防止雪崩，是系统防护中重要的一环。让系统的入口流量和系统的负载达到一个平衡，保证系统在能力范围之内处理最多的请求。

### 黑白名单  热点参数限流   实时监控  动态规则配置（Zk  Apollo  Nacos）

