# 秒杀系统架构

## 什么是秒杀

什么是秒杀？通俗一点讲就是网络商家为促销等目的组织的网上限时抢购活动

## 业务特点

* 瞬时并发量大

秒杀时会有大量用户在同一时间进行抢购，瞬时并发访问量突增 10 倍，甚至 100 倍以上都有。

* 库存量少

一般秒杀活动商品量很少，这就导致了只有极少量用户能成功购买到。

* 业务简单

流程比较简单，一般都是下订单、扣库存、支付订单

## 技术难点

* 现有业务的冲击

秒杀是营销活动中的一种，如果和其他营销活动应用部署在同一服务器上，肯定会对现有其他活动造成冲击，极端情况下可能导致整个电商系统服务宕机

* 直接下订单

下单页面是一个正常的 URL 地址，需要控制在秒杀开始前，不能下订单，只能浏览对应活动商品的信息。简单来说，需要 Disable 订单按钮

* 页面流量突增

秒杀活动开始前后，会有很多用户请求对应商品页面，会造成后台服务器的流量突增，同时对应的网络带宽增加，需要控制商品页面的流量不会对后台服务器、DB、Redis 等组件的造成过大的压力

## 系统架构思想

![WX20190414-134029@2x](https://i.imgur.com/CXN4hS1.png)


* 客户端优化
  * 秒杀页面 页面整体进行静态化，并将页面静态化之后的页面分发到 CDN 边缘节点上，起到压力分散的作用
  * 防止提前下单 disable 按钮
* API 接入层优化
  * 限制用户维度访问频率
  * 限制商品维度访问频率

![WX20190414-134401@2x](https://i.imgur.com/ARKpkyg.png)

秒杀系统核心在于层层过滤，逐渐递减瞬时访问压力，减少最终对数据库的冲击。通过上面流程图就会发现压力最大的地方在哪里？

MQ 排队服务，只要 MQ 排队服务顶住，后面下订单与扣减库存的压力都是自己能控制的，根据数据库的压力，可以定制化创建订单消费者的数量，避免出现消费者数据量过多，导致数据库压力过大或者直接宕机。

库存服务专门为秒杀的商品提供库存管理，实现提前锁定库存，避免超卖的现象。同时，通过超时处理任务发现已抢到商品，但未付款的订单，并在规定付款时间后，处理这些订单，将恢复订单商品对应的库存量

* 不要给数据库太大压力

>　　I：　首先MySQL自身对于高并发的处理性能就会出现问题，一般来说，MySQL的处理性能会随着并发thread上升而上升，但是到了一定的并发度之后会出现明显的拐点，之后一路下降，最终甚至会比单thread的性能还要差。    
>　　II： 其次，超卖的根结在于减库存操作是一个事务操作，需要先select，然后insert，最后update -1。最后这个-1操作是不能出现负数的，但是当多用户在有库存的情况下并发操作，出现负数这是无法避免的。        
>　　III：最后，当减库存和高并发碰到一起的时候，由于操作的库存数目在同一行，就会出现争抢InnoDB行锁的问题，导致出现互相等待甚至死锁，从而大大降低MySQL的处理性能，最终导致前端页面出现超时异常。

无论是MySQL、Oracle、还是其他关系型数据库，这会造成大量无意义的上下文切换，从而导致资源浪费。假设在网易考拉上有10000个用户对skuId=1的这件商品进行抢购，那么每个时间点仅有一个用户可以获得进入数据库操作的权限，剩下的9999个用户需要等待，待前面的用户完成操作后，会唤醒9999个用户，告诉他们现在可以进入了，9999个用户重新争夺一次，最终又仅有一个用户进入，这就是所谓的上下文切换。在秒杀场景下，这个代价将会非常大，一个显著的表现是CPU负载非常高，但数据库请求的负载却又非常低。

## 总结

!> 核心思想：层层过滤

* 尽量将请求拦截在上游，降低下游的压力

* 充分利用缓存与消息队列，提高请求处理速度以及削峰填谷的作用