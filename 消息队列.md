# 消息队列

## What 

消息队列中间件是分布式系统中的重要组件，提供消息订阅和发布的能力。主要用于应用解耦，异步消息，流量削峰等问题，实现高性能，高可用，可伸缩和最终一致性架构。目前使用较多的消息队列有
ActiveMQ，RabbitMQ，RocketMQ，Kafka

## Why 

### 消息队列的应用场景

* 应用解耦

![270324-20160730143228325-953675504](/assets/270324-20160730143228325-953675504.png)

假如：在下单时库存系统不能正常使用。也不影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了。实现订单系统与库存系统的应用解耦

* 异步处理

![te](/assets/te.png)

* 流量削峰 xue

流量削锋也是消息队列中的常用场景，**一般在秒杀或团抢活动中使用广泛。**
应用场景：秒杀活动，一般会因为流量过大，导致流量暴增，应用挂掉。为解决这个问题，一般需要在应用前端加入消息队列。
a、可以控制活动的人数
b、可以缓解短时间内高流量压垮应用

![aa1](/assets/aa1.png)
用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转到错误页面。
秒杀业务根据消息队列中的请求信息，再做后续处理

* 日志处理

日志处理是指将消息队列用在日志处理中，比如Kafka的应用，解决大量日志传输的问题。

* 消息通讯

消息通讯是指，消息队列一般都内置了高效的通信机制，因此也可以用在纯的消息通讯。比如实现点对点消息队列，或者聊天室等


## How

### 消息队列需要解决哪些问题

* Publish/Subscribe 发布订阅是消息中间件的最基本功能，也是相对于传统RPC通信而言。在此不再详述。
* Message Priority 消息优先级
* Message Order 消息有序
* Message Filter 消息过滤
  1. Broker端消息过滤    优点是减少了对于Consumer无用消息的网络传输。缺点是增加了Broker的负担，实现相对复杂。
  2. Consumer端消息过滤  这种过滤方式可由应用完全自定义实现，但是缺点是很多无用的消息要传输到Consumer端。
* Message Persistence 消息持久化
  1. 持久化到数据库
  2. 持久化到KV存储
  3. 文件记录形式持久化，例如Kafka，RocketMQ
  4. 对内存数据做一个持久化镜像
* Message Reliablity 消息可靠性
* Low Latency Messaging 消息低延迟  在消息不堆积情况下，消息到达Broker后，能立刻到达Consumer。
  RocketMQ使用长轮询Pull方式，可保证消息非常实时，消息实时性不低于Push。
* At least Once 每个消息必须投递一次。
* Exactly Only Once
  1. 发送消息阶段，不允许发送重复的消息。
  2. 消费消息阶段，不允许消费重复的消息。
* 回溯消费 回溯消费是指Consumer已经消费成功的消息，由于业务上需求需要重新消费，要支持此功能，Broker在向Consumer投递成功消息后，消息仍然需要保留
* 消息堆积 消息中间件的主要功能是异步解耦，还有个重要功能是挡住前端的数据洪峰，保证后端系统的稳定性，这就要求消息中间件具有一定的消息堆积能力，
* 定时消息 定时消息是指消息发到Broker后，不能立刻被Consumer消费，要到特定的时间点或者等待特定的时间后才能被消费。RocketMQ支持定时消息，但是不支持任意时间精度，支持特定的level，例如定时5s，10s，1m等。
* 消息重试 Consumer消费消息失败后，要提供一种重试机制，令消息再消费一次。